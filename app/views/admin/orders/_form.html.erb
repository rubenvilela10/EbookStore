<%= form_with(model: order) do |form| %>
  <% if order.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(order.errors.count, "error") %> prohibited this order from being saved:</h2>

      <ul>
        <% order.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :buyer_id, "Buyer" %>
    <%= form.collection_select :buyer_id, User.where(role: "buyer"), :id, :name %>
  </div>

  <div>
    <%= form.label :destination_address %>
    <%= form.text_field :destination_address %>
  </div>

  <div>
    <%= form.label :billing_address %>
    <%= form.text_field :billing_address %>
  </div>

  <div>
    <%= form.label :payment_status %>
    <%= form.select :payment_status, Order::STATUSES %>
  </div>

  <hr>

  <h3>Ebooks</h3>

  <div id="order-items">
    <%= form.fields_for :order_items do |item_form| %>
      <%= render "order_item_fields", f: item_form %>
    <% end %>
  </div>

  <template id="order-item-template">
    <div class="order-item-fields">
      <label>Ebook</label>
      <select name="order[order_items_attributes][][ebook_id]">
        <% Ebook.all.each do |ebook| %>
          <option value="<%= ebook.id %>"><%= ebook.title %></option>
        <% end %>
      </select>

      <a href="#" data-action="remove-item">Remove</a>
      <hr>
    </div>
  </template>

  <%= link_to "Add Ebook", "#", id: "add-order-item" %>

  <hr>

  <%= form.submit %>
<% end %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const addButton = document.getElementById("add-order-item");
  const itemsContainer = document.getElementById("order-items");

  addButton.addEventListener("click", event => {
    event.preventDefault();

    // pega o template hidden
    const template = document.getElementById("order-item-template");
    const clone = template.content.cloneNode(true);

    // adiciona ao container
    itemsContainer.appendChild(clone);
  });
});
</script>